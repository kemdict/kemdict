---
import { uniq } from "lodash-es";
import { getHeteronyms, getBacklinks } from "$src/server/db";
import {
  dictIdsToLangs,
  dictsToObj,
  dicts,
  langs,
  groupByProp,
  parseLangParam,
} from "common";
import type { Dict, Heteronym } from "common";

const { title } = Astro.params;
const [presentDictIds, heteronyms] = getHeteronyms(title);
const titles = uniq(heteronyms.map((het: Heteronym) => het.title));
const backlinks = getBacklinks(...titles).sort();

import SingleLayout from "$src/SingleLayout.astro";
import { Tab, TabGroup } from "@skeletonlabs/skeleton";
import TOC from "$src/components/TOC.astro";
import Elsewhere from "$src/components/Elsewhere.astro";
import WordList from "$src/components/WordList.astro";
import Word from "./Word.svelte";
import WordTabs from "./WordTabs.svelte";

const dictsObj = dictsToObj(dicts);
const groupedHets: [Dict, Heteronym[]][] = groupByProp(heteronyms, "from").map(
  ([id, hets]: [string, Heteronym[]]) => {
    return [dictsObj[id], hets];
  }
);
const presentDicts = presentDictIds.map((id) => dictsObj[id]);
const presentLangs = dictIdsToLangs(...presentDictIds);

const url = Astro.url;
const requestedLang = parseLangParam(
  url.searchParams.get("lang"),
  presentLangs
);
// Invalid -> delete it and try again
if (requestedLang === false) {
  url.searchParams.delete("lang");
  return Astro.redirect(url);
}
---

{
  heteronyms.length > 0 ? (
    <SingleLayout
      wide={true}
      title={`「${title}」 - kemdict`}
      initialInput={title}
    >
      <Fragment slot="head">
        <meta name="description" content="「{title}」的定義" />
      </Fragment>
      <div class="w-full md:flex md:flex-row-reverse md:gap-x-8">
        <div class="md:w-5/12">
          <div class="hidden md:block">
            <TOC presentDicts={presentDicts} />
            <Elsewhere term={title} />
            {backlinks.length > 0 && (
              <div class="prose">
                <h2>有提到「{title}」的條目</h2>
                <WordList words={backlinks} />
              </div>
            )}
          </div>
        </div>
        <div class="md:w-7/12">
          <div class="md:hidden">
            <TOC term={title} presentDicts={presentDicts} />
          </div>
          <WordTabs
            title={title}
            presentLangs={[...presentLangs]}
            requestedLang={requestedLang}
            groupedHets={groupedHets}
            currentParams={url.searchParams}
          />
          <div class="md:hidden">
            <Elsewhere term={title} />
            {backlinks.length > 0 && (
              <div class="prose">
                <h2>有提到「{title}」的條目</h2>
                <WordList words={backlinks} />
              </div>
            )}
          </div>
        </div>
      </div>
    </SingleLayout>
  ) : (
    <SingleLayout
      title={`找不到「${title}」 - Kemdict 國語整合典`}
      class="prose"
    >
      <h1>{title}</h1>
      <p>找不到這個詞。</p>
      <hr />
      <Elsewhere term={title} />
    </SingleLayout>
  )
}
