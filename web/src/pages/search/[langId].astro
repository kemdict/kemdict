---
import { site, parsePageParam, langs, getSearchTitle } from "common";
import { chunk } from "lodash-es";
const { langId } = Astro.params;
import { getHetFromUrl } from "$src/server/db";
const url = Astro.url;
const [success, data] = await getHetFromUrl(url, langId);
if (!success) {
  return Astro.redirect(data);
}
const heteronyms = data.heteronyms;
const mtch = data.mtch;
const query = data.query;
const langSet = data.langSet;
// We pass langCountObj around because the other option is to pass both
// all heteronyms and applicable heteronyms here.
const langCountObj = data.langCountObj;

// This preserves order as declared in common.
const langGroups = Object.entries(langs).filter((l) => langSet.has(l[0]));
const count = heteronyms.length;

// If there are no matching heteronyms specific to this language, try all languages instead.
if (count === 0) {
  return Astro.redirect(`/search?${url.searchParams.toString()}`);
}

// We do the chunking in Javascript and not in SQL because we still need the
// total number of results
const chunked = chunk(heteronyms, 50);
const page = parsePageParam(url.searchParams.get("p"), chunked.length);
// If "?p" is invalid, delete it and try again
if (page === false) {
  url.searchParams.delete("p");
  return Astro.redirect(url);
}

import SingleLayout from "$src/SingleLayout.astro";
import SingleLangResults from "./SingleLangResults.svelte";
import Elsewhere from "$src/components/Elsewhere.astro";
const title = getSearchTitle(mtch, query);
const titleMarkup = getSearchTitle(mtch, query, true);
---

<SingleLayout
  title={`${title} - ${langs[langId]}辭典 - ${site.title}`}
  initialMatchSelection={mtch}
  initialInput={query}
  submitSuffix={`/${langId}`}
>
  <Fragment slot="head">
    <meta
      property="og:image"
      content={`https://kemdict.com/og-image?title=${title} - ${langs[langId]}`}
    />
    <meta
      name="description"
      content={`在${langs[langId]}收錄辭典中搜尋${title}的結果。 - ${site.oneLineDesc}`}
    />
  </Fragment>
  <h1 class="mt-8 text-2xl" set:html={titleMarkup} />
  <SingleLangResults
    pageCount={chunked.length}
    url={Astro.url}
    baseURL={Astro.site}
    activePage={page}
    langGroups={langGroups}
    langId={langId}
    langCountObj={langCountObj}
    currentParamsString={url.searchParams.toString()}
    heteronyms={chunked[page - 1]}
    searchQuery={query}
  />
</SingleLayout>
